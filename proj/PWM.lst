A51 MACRO ASSEMBLER  PWM                                                                  03/29/2016 16:57:36 PAGE     1


MACRO ASSEMBLER A51 V8.01
OBJECT MODULE PLACED IN .\PWM.obj
ASSEMBLER INVOKED BY: C:\Keil_C51\C51\BIN\A51.EXE ..\src\PWM.asm INCDIR(..\inc) SET(SMALL) DEBUG PRINT(.\PWM.lst) OBJECT
                      (.\PWM.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     NAME PWM
                       2     PUBLIC _PWMSet, PWMStart
                       3     
                       4     ;$include (GPIOcfg.inc)
                +1     5     ;******************************************
                +1     6     ;                                                                                  
                +1     7     ; Pin definitions:                                                 
                +1     8     ;                                                                                  
                +1     9     ;******************************************
  00C0          +1    10     p4 data 0xc0    ;GPIO P4 for stc15
  00C8          +1    11     p5 data 0xc8    ;GPIO P5 for stc15
                +1    12     
  00A5          +1    13     OUT1    BIT P2.5
  00A6          +1    14     OUT2    BIT P2.6
  00A7          +1    15     OUT3    BIT P2.7
  00C5          +1    16     OUT4    BIT P4.5
  00C6          +1    17     OUT5    BIT P4.6
  0080          +1    18     OUT6    BIT P0.0
  0081          +1    19     OUT7    BIT P0.1
  0082          +1    20     OUT8    BIT P0.2
  0083          +1    21     OUT9    BIT P0.3
  0084          +1    22     OUT10   BIT P0.4
  00CD          +1    23     OUT11   BIT P5.5
  00A4          +1    24     OUT12   BIT P2.4
                +1    25     
                +1    26     ; You must set the following reload marcos
                +1    27     ; according to the pins defined above!
  001F          +1    28     p0reload equ 00011111b
  00F0          +1    29     p2reload equ 11110000b
  0060          +1    30     p4reload equ 01100000b
  0020          +1    31     p5reload equ 00100000b
                +1    32     
                +1    33     ;******************************************
                +1    34     ;                                                                                  
                +1    35     ; Maximun servo degree
                +1    36     ;                                                                                  
                +1    37     ;******************************************
  00B4          +1    38     MAXDEGREE equ 180
                      39     
                      40     
                      41     ;******************************************
                      42     ;                                                                                  
                      43     ; Private Marcos:                                                  
                      44     ;                                                                                  
                      45     ;******************************************
                      46     ; timer reset values:
  4403                47     _17_5ms equ -48125
  F98E                48     _0_6ms  equ -1650
  FFE5                49     _10us   equ -27
                      50     
                      51     ;******************************************
                      52     ;
                      53     ; DATA segment
                      54     ;
                      55     ;******************************************
                      56     mybits          segment DATA BITADDRESSABLE
                      57     emu_TIMs        segment DATA
A51 MACRO ASSEMBLER  PWM                                                                  03/29/2016 16:57:36 PAGE     2

                      58     
                      59     ; First, declear some BOOL varibles:
----                  60             RSEG mybits
0000                  61     bits:   DS      4               ; We used 32 bits.
  0000                62     allzero BIT     bits.0  ; Show that all PWM channels 
                      63                                             ; had been reset to 0.
                      64     ; Next, declear 12 emulated TIM coltrol-bit:
                      65     IRP emu_TR_num, <0,1,2,3,4,5,6,7,8,9,10,11>
                      66     emuTR&emu_TR_num        BIT    allzero + &emu_TR_num
                      67     ENDM
                      80     ; Then, declear 12 emulated TIM counters:
----                  81             RSEG emu_TIMs
0000                  82     emuCNTs:        DS      12
                      83     ; And, declear 12 TIM reload varibles:
000C                  84     emuCCRs:        DS      12
                      85     ; Finally, declear a MAIN TIM counter:
0018                  86     emuMCNT:        DS      1
                      87     
                      88                                                                                        
                      89     ;******************************************
                      90     ;
                      91     ; PWM interfaces:
                      92     ;                                                                                  
                      93     ;******************************************
                      94     ;**                                                                              **
                      95     ;*      PWMSet(char channel, char degree);        *
                      96     ;**                                                                              **
                      97     PWMSet?PWM                      SEGMENT CODE
----                  98             RSEG PWMSet?PWM
0000                  99     _PWMSet:          
0000 C0D0            100             push PSW
0002 C0E0            101             push ACC
0004 E8              102             mov A, R0
0005 C0E0            103             push ACC
0007 ED              104             mov A, R5
0008 F8              105             mov R0, A
0009 1F              106             dec R7
000A 7400     F      107             mov A, #emuCCRs
000C 2F              108             add A, R7               ; CCR dst address
000D C8              109             xch A, R0
000E F6              110             mov @R0, A
000F C8              111             xch A, R0
0010 7400     F      112             mov A, #emuCNTs
0012 2F              113             add A, R7               ; CNT dst address
0013 C8              114             xch A, R0
0014 F6              115             mov @R0, A
0015 D0E0            116             pop ACC
0017 F8              117             mov R0, A
0018 D0E0            118             pop ACC
001A D0D0            119             pop PSW
001C 22              120             ret
                     121     
                     122     ;**                                                                              **
                     123     ;*      PWMStart(void);                                           *
                     124     ;**                                                                              **
                     125     PWMStart?PWM            SEGMENT CODE
----                 126             RSEG PWMStart?PWM
0000                 127     PWMStart:
0000 C28C            128             clr tr0
                     129             ; reset PWM emulated timers
0002 D200     F      130             setb allzero
0004 7500B4   F      131             mov emuMCNT, #MAXDEGREE
                     132             ; reset t0;17.5ms
0007 758A03          133             mov tl0, #_17_5ms & 0xff
000A 758C44          134             mov th0, #_17_5ms >> 8
000D D2A9            135             setb et0                ;enable t0 interrupt
A51 MACRO ASSEMBLER  PWM                                                                  03/29/2016 16:57:36 PAGE     3

000F D2AF            136             setb ea                 ;enable all interrupts
0011 D28C            137             setb tr0                ;start t0
0013 22              138             ret
                     139     
                     140     ;******************************************
                     141     ;
                     142     ; TIM0 IRQ
                     143     ;       Update output pins to generate pulses
                     144     ;                                                                                  
                     145     ;******************************************
----                 146     CSEG AT 0X000B
000B 020000   F      147             ljmp T0_IRQ
                     148     T0_IRQ?PWM              SEGMENT CODE
----                 149             RSEG T0_IRQ?PWM
0000                 150     T0_IRQ:
0000 100002   F      151             jbc allzero, reload_all
0003 801D            152             jmp gen_PWM
0005                 153     reload_all:
0005 C28C            154             clr tr0                         ; stop T0
0007 43801F          155             orl P0, #p0reload       ; reload PWM outputs
000A 43A0F0          156             orl P2, #p2reload
000D 43C060          157             orl P4, #p4reload
0010 43C820          158             orl P5, #p5reload
0013 758A8E          159             mov tl0, #_0_6ms & 0xff         ;reload T0
0016 758CF9          160             mov th0, #_0_6ms >> 8
0019 D28C            161             setb tr0                                        ;start T0
001B 758AE5          162             mov tl0, #_10us & 0xff  ;Now set the reload
001E 758CFF          163             mov th0, #_10us >> 8    ;value: 10us
0021 32              164             RETI
0022                 165     gen_PWM:
0022 C0D0            166             push psw
                     167             ; Next, increase and check PWM timers one by one...
                     168     IRP PWM_TIM_num, <1,2,3,4,5,6,7,8,9,10,11,12>
                     169             jnb OUT&PWM_TIM_num, PWMCh&PWM_TIM_num
                     170             djnz (emuCNTs + &PWM_TIM_num - 1), PWMCh&PWM_TIM_num
                     171             clr OUT&PWM_TIM_num
                     172     PWMCh&PWM_TIM_num:
                     173     ENDM
0084 D50037   F      222             djnz emuMCNT, IRQRet
                     223             ; reload T0 and interrupt after 17.5ms
0087 C28C            224             clr TR0
0089 758A03          225             mov tl0, #_17_5ms & 0xff
008C 758C44          226             mov th0, #_17_5ms >> 8
008F D28C            227             setb TR0
                     228             ; reload all PWM timers
0091 7500B4   F      229             mov emuMCNT, #MAXDEGREE
                     230     IRP PWM_CNT_num, <0,1,2,3,4,5,6,7,8,9,10,11>
                     231             mov (emuCNTs + &PWM_CNT_num), (emuCCRs + &PWM_CNT_num)
                     232     ENDM
                     245             ; and then start them all
00B8 7500FF   F      246             mov bits, #0xff
00BB 7500FF   F      247             mov bits+1, #0xff
00BE                 248     IRQRet:
00BE D0D0            249             pop psw
00C0 32              250             RETI
                     251     
                     252     END
A51 MACRO ASSEMBLER  PWM                                                                  03/29/2016 16:57:36 PAGE     4

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

ACC. . . . . . . .  D ADDR   00E0H   A   
ALLZERO. . . . . .  B ADDR   0000H.0 R   SEG=MYBITS
BITS . . . . . . .  D ADDR   0000H   R   SEG=MYBITS
EA . . . . . . . .  B ADDR   00A8H.7 A   
EMUCCRS. . . . . .  D ADDR   000CH   R   SEG=EMU_TIMS
EMUCNTS. . . . . .  D ADDR   0000H   R   SEG=EMU_TIMS
EMUMCNT. . . . . .  D ADDR   0018H   R   SEG=EMU_TIMS
EMUTR0 . . . . . .  B ADDR   0000H.0 R   SEG=MYBITS
EMUTR1 . . . . . .  B ADDR   0000H.1 R   SEG=MYBITS
EMUTR10. . . . . .  B ADDR   0001H.2 R   SEG=MYBITS
EMUTR11. . . . . .  B ADDR   0001H.3 R   SEG=MYBITS
EMUTR2 . . . . . .  B ADDR   0000H.2 R   SEG=MYBITS
EMUTR3 . . . . . .  B ADDR   0000H.3 R   SEG=MYBITS
EMUTR4 . . . . . .  B ADDR   0000H.4 R   SEG=MYBITS
EMUTR5 . . . . . .  B ADDR   0000H.5 R   SEG=MYBITS
EMUTR6 . . . . . .  B ADDR   0000H.6 R   SEG=MYBITS
EMUTR7 . . . . . .  B ADDR   0000H.7 R   SEG=MYBITS
EMUTR8 . . . . . .  B ADDR   0001H.0 R   SEG=MYBITS
EMUTR9 . . . . . .  B ADDR   0001H.1 R   SEG=MYBITS
EMU_TIMS . . . . .  D SEG    0019H       REL=UNIT
ET0. . . . . . . .  B ADDR   00A8H.1 A   
GEN_PWM. . . . . .  C ADDR   0022H   R   SEG=T0_IRQ?PWM
IRQRET . . . . . .  C ADDR   00BEH   R   SEG=T0_IRQ?PWM
MAXDEGREE. . . . .  N NUMB   00B4H   A   
MYBITS . . . . . .  D SEG    0004H       REL=BITADDRESSABLE
OUT1 . . . . . . .  B ADDR   00A0H.5 A   
OUT10. . . . . . .  B ADDR   0080H.4 A   
OUT11. . . . . . .  B ADDR   00C8H.5 A   
OUT12. . . . . . .  B ADDR   00A0H.4 A   
OUT2 . . . . . . .  B ADDR   00A0H.6 A   
OUT3 . . . . . . .  B ADDR   00A0H.7 A   
OUT4 . . . . . . .  B ADDR   00C0H.5 A   
OUT5 . . . . . . .  B ADDR   00C0H.6 A   
OUT6 . . . . . . .  B ADDR   0080H.0 A   
OUT7 . . . . . . .  B ADDR   0080H.1 A   
OUT8 . . . . . . .  B ADDR   0080H.2 A   
OUT9 . . . . . . .  B ADDR   0080H.3 A   
P0 . . . . . . . .  D ADDR   0080H   A   
P0RELOAD . . . . .  N NUMB   001FH   A   
P2 . . . . . . . .  D ADDR   00A0H   A   
P2RELOAD . . . . .  N NUMB   00F0H   A   
P4 . . . . . . . .  D ADDR   00C0H   A   
P4RELOAD . . . . .  N NUMB   0060H   A   
P5 . . . . . . . .  D ADDR   00C8H   A   
P5RELOAD . . . . .  N NUMB   0020H   A   
PSW. . . . . . . .  D ADDR   00D0H   A   
PWM. . . . . . . .  N NUMB   -----       
PWMCH1 . . . . . .  C ADDR   002CH   R   SEG=T0_IRQ?PWM
PWMCH10. . . . . .  C ADDR   0074H   R   SEG=T0_IRQ?PWM
PWMCH11. . . . . .  C ADDR   007CH   R   SEG=T0_IRQ?PWM
PWMCH12. . . . . .  C ADDR   0084H   R   SEG=T0_IRQ?PWM
PWMCH2 . . . . . .  C ADDR   0034H   R   SEG=T0_IRQ?PWM
PWMCH3 . . . . . .  C ADDR   003CH   R   SEG=T0_IRQ?PWM
PWMCH4 . . . . . .  C ADDR   0044H   R   SEG=T0_IRQ?PWM
PWMCH5 . . . . . .  C ADDR   004CH   R   SEG=T0_IRQ?PWM
PWMCH6 . . . . . .  C ADDR   0054H   R   SEG=T0_IRQ?PWM
PWMCH7 . . . . . .  C ADDR   005CH   R   SEG=T0_IRQ?PWM
PWMCH8 . . . . . .  C ADDR   0064H   R   SEG=T0_IRQ?PWM
PWMCH9 . . . . . .  C ADDR   006CH   R   SEG=T0_IRQ?PWM
PWMSET?PWM . . . .  C SEG    001DH       REL=UNIT
A51 MACRO ASSEMBLER  PWM                                                                  03/29/2016 16:57:36 PAGE     5

PWMSTART . . . . .  C ADDR   0000H   R   SEG=PWMSTART?PWM
PWMSTART?PWM . . .  C SEG    0014H       REL=UNIT
RELOAD_ALL . . . .  C ADDR   0005H   R   SEG=T0_IRQ?PWM
T0_IRQ . . . . . .  C ADDR   0000H   R   SEG=T0_IRQ?PWM
T0_IRQ?PWM . . . .  C SEG    00C1H       REL=UNIT
TH0. . . . . . . .  D ADDR   008CH   A   
TL0. . . . . . . .  D ADDR   008AH   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
_0_6MS . . . . . .  N NUMB   F98EH   A   
_10US. . . . . . .  N NUMB   FFE5H   A   
_17_5MS. . . . . .  N NUMB   4403H   A   
_PWMSET. . . . . .  C ADDR   0000H   R   SEG=PWMSET?PWM


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
